<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Previous Records</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.materialdesignicons.com/5.3.45/css/materialdesignicons.min.css"
    />
  </head>
  <body>
    <main id="app">
      <section class="section">
        <div class="container">
          <h1 class="title">Previous Records</h1>
          <b-field label="Select Location">
            <b-select
              v-model="selectedLocation"
              placeholder="Select a location"
              expanded
            >
              <option
                v-for="record in recordArr"
                :value="record.data.location"
                :key="record.id"
              >
                {{ record.data.location }}
              </option>
            </b-select>
          </b-field>
          <b-field label="Select Date">
            <b-select
              v-model="selectedRecord"
              placeholder="Select a date"
              expanded
            >
              <option
                v-for="record in filteredRecords"
                :value="record"
                :key="record.id"
              >
                {{ record.id }}
              </option>
            </b-select>
          </b-field>

          <div v-if="selectedRecord">
            <div
              class="card mb-4"
              v-for="section in selectedRecord.data.questions"
              :key="section.name"
            >
              <header class="card-header">
                <p class="card-header-title">{{section.name}}</p>
              </header>
              <div class="card-content">
                <div class="mb-6" v-for="question in section.questions">
                  <h3 class="title is-5">{{question.name}}</h3>
                  <div class="box" v-for="subq in question.subQuestions">
                    <h4 class="subtitle">{{subq.qn}}</h4>
                    <p class="has-text-weight-bold is-size-6">Answer:</p>
                    <p>{{subq.answerBool}}</p>
                    <p class="has-text-weight-bold is-size-6">
                      Recommendation/Corrective Actions:
                    </p>
                    <p>{{subq.actions}}</p>
                    <p class="has-text-weight-bold is-size-6">Action By:</p>
                    <p>{{subq.by}}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <script src="./init-firebase.js" type="text/javascript"></script>
    <script>
      new Vue({
        el: "#app",
        data() {
          return {
            recordArr: [],
            selectedRecord: null,
            selectedLocation: null,
          };
        },
        computed: {
          filteredRecords() {
            retArr = [];
            retArr = this.recordArr.filter((record) => {
              return record.data.location === this.selectedLocation;
            });
            return retArr;
          },
        },
        mounted() {
          this.read();
        },
        methods: {
          async read() {
            try {
              const res = await db.collection("formData").get();
              for (const doc of res.docs) {
                this.recordArr.push({ id: doc.id, data: doc.data() });
              }
            } catch (error) {
              console.log("Error getting documents: ", error);
            }
          },
        },
      });
    </script>
  </body>
</html>
